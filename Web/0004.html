<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Web上的MediaRecorder更换stream(录制过程中切换摄像头) | winka9587&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Is anyone there?">
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.66c04e2d.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.8719d32f.js" as="script"><link rel="preload" href="/my-blog/assets/js/2.fe61bd6b.js" as="script"><link rel="preload" href="/my-blog/assets/js/10.96b7d755.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/11.94221570.js"><link rel="prefetch" href="/my-blog/assets/js/12.cda01586.js"><link rel="prefetch" href="/my-blog/assets/js/13.be30332a.js"><link rel="prefetch" href="/my-blog/assets/js/14.3776679c.js"><link rel="prefetch" href="/my-blog/assets/js/15.1be49f13.js"><link rel="prefetch" href="/my-blog/assets/js/16.f19ac87a.js"><link rel="prefetch" href="/my-blog/assets/js/17.def0ab1f.js"><link rel="prefetch" href="/my-blog/assets/js/18.708e7573.js"><link rel="prefetch" href="/my-blog/assets/js/19.66596390.js"><link rel="prefetch" href="/my-blog/assets/js/20.3995b6ee.js"><link rel="prefetch" href="/my-blog/assets/js/21.1c7f65f7.js"><link rel="prefetch" href="/my-blog/assets/js/22.6664bb7c.js"><link rel="prefetch" href="/my-blog/assets/js/23.43617db7.js"><link rel="prefetch" href="/my-blog/assets/js/24.67d6fbed.js"><link rel="prefetch" href="/my-blog/assets/js/25.41d7c9b1.js"><link rel="prefetch" href="/my-blog/assets/js/26.f2a09d11.js"><link rel="prefetch" href="/my-blog/assets/js/27.0a80dbf8.js"><link rel="prefetch" href="/my-blog/assets/js/28.793261c3.js"><link rel="prefetch" href="/my-blog/assets/js/29.d7e6e503.js"><link rel="prefetch" href="/my-blog/assets/js/3.82c0e95c.js"><link rel="prefetch" href="/my-blog/assets/js/30.54d620af.js"><link rel="prefetch" href="/my-blog/assets/js/31.890c2d76.js"><link rel="prefetch" href="/my-blog/assets/js/32.78089df6.js"><link rel="prefetch" href="/my-blog/assets/js/33.df07fc4f.js"><link rel="prefetch" href="/my-blog/assets/js/34.faedcc52.js"><link rel="prefetch" href="/my-blog/assets/js/35.a6a32fa5.js"><link rel="prefetch" href="/my-blog/assets/js/36.b7734f20.js"><link rel="prefetch" href="/my-blog/assets/js/37.d2986868.js"><link rel="prefetch" href="/my-blog/assets/js/38.8df975a8.js"><link rel="prefetch" href="/my-blog/assets/js/39.c07b108e.js"><link rel="prefetch" href="/my-blog/assets/js/4.96218e05.js"><link rel="prefetch" href="/my-blog/assets/js/40.09555f17.js"><link rel="prefetch" href="/my-blog/assets/js/41.3d998535.js"><link rel="prefetch" href="/my-blog/assets/js/42.0e3c99bf.js"><link rel="prefetch" href="/my-blog/assets/js/43.315f3388.js"><link rel="prefetch" href="/my-blog/assets/js/5.9e62da6c.js"><link rel="prefetch" href="/my-blog/assets/js/6.3d281fcb.js"><link rel="prefetch" href="/my-blog/assets/js/7.cc12d867.js"><link rel="prefetch" href="/my-blog/assets/js/8.f68e3932.js"><link rel="prefetch" href="/my-blog/assets/js/9.4fb889cc.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.66c04e2d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><!----> <span class="site-name">winka9587's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="winka的Blog" class="dropdown-title"><span class="title">winka的Blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="winka的Blog" class="mobile-dropdown-title"><span class="title">winka的Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/winka9587" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Vikanill" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="winka的Blog" class="dropdown-title"><span class="title">winka的Blog</span> <span class="arrow down"></span></button> <button type="button" aria-label="winka的Blog" class="mobile-dropdown-title"><span class="title">winka的Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/winka9587" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/Vikanill" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/my-blog/" class="sidebar-heading clickable router-link-active"><span>主页</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/" aria-current="page" class="sidebar-link">README</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/my-blog/Category-level/0001.html" class="sidebar-heading clickable"><span>类级别</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/Category-level/0001.html" class="sidebar-link">NOCS</a></li><li><a href="/my-blog/Category-level/0002.html" class="sidebar-link">SPD</a></li><li><a href="/my-blog/Category-level/0003.html" class="sidebar-link">关于normal</a></li><li><a href="/my-blog/Category-level/0004.html" class="sidebar-link">关于curvature</a></li><li><a href="/my-blog/Category-level/0005.html" class="sidebar-link">CAPTRA部分代码解读</a></li><li><a href="/my-blog/Category-level/0006.html" class="sidebar-link">about数据集</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/my-blog/ComputerGraphics/" class="sidebar-heading clickable"><span>再见了,所有的图形学作业</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/ComputerGraphics/0002.html" class="sidebar-link">OpenGL使用Laplacian进行网格光顺</a></li><li><a href="/my-blog/ComputerGraphics/0003.html" class="sidebar-link">从Mat_中提取数据失败:Mat_与Mat的区别</a></li><li><a href="/my-blog/ComputerGraphics/0001.html" class="sidebar-link">[WebGL]点击改变面的贴图</a></li><li><a href="/my-blog/ComputerGraphics/0005.html" class="sidebar-link">OpenCV Error: Mat踩坑踩到死</a></li><li><a href="/my-blog/ComputerGraphics/0006.html" class="sidebar-link">Loop Subdivision与Modified Butterfly Subdivision</a></li><li><a href="/my-blog/ComputerGraphics/0007.html" class="sidebar-link">OpenGL通过glRasterPos设置当前光栅坐标实现分屏效果</a></li><li><a href="/my-blog/ComputerGraphics/0004.html" class="sidebar-link">[踩坑记录]ARCore for Unity2019</a></li><li><a href="/my-blog/ComputerGraphics/0008.html" class="sidebar-link">[踩坑记录]VS2017+大恒MER-131-210U3C相机</a></li><li><a href="/my-blog/ComputerGraphics/0009.html" class="sidebar-link">[unity]C#脚本调用外部exe</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/my-blog/Web/" class="sidebar-heading clickable router-link-active open"><span>Web</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/Web/0001.html" class="sidebar-link">解决'express' 不是内部或外部命令，也不是可运行的程序 或批处理文件</a></li><li><a href="/my-blog/Web/0002.html" class="sidebar-link">关于更新node.js以及npm</a></li><li><a href="/my-blog/Web/0003.html" class="sidebar-link">配置turn服务器实现nat穿透</a></li><li><a href="/my-blog/Web/0004.html" aria-current="page" class="active sidebar-link">web上的mediarecorder更换stream(录制过程中切换摄像头)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my-blog/Web/0004.html#过程" class="sidebar-link">过程</a></li><li class="sidebar-sub-header"><a href="/my-blog/Web/0004.html#mediarecorder无法start" class="sidebar-link">MediaRecorder无法start</a></li><li class="sidebar-sub-header"><a href="/my-blog/Web/0004.html#demo" class="sidebar-link">Demo</a></li></ul></li><li><a href="/my-blog/Web/0005.html" class="sidebar-link">通过mediarecorder+mediasource实现h5直播,以及关于webrtc直播的问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/my-blog/MachineLearning/" class="sidebar-heading clickable"><span>机器不学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/MachineLearning/0001.html" class="sidebar-link">基于SVM的划线框识别(1)HOG特征提取</a></li><li><a href="/my-blog/MachineLearning/0002.html" class="sidebar-link">基于SVM的划线框识别(2)ROC曲线(二分类)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/my-blog/ROS/" class="sidebar-heading clickable"><span>ROS</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/my-blog/ROS/0001.html" class="sidebar-link">ROS Day1</a></li><li><a href="/my-blog/ROS/0002.html" class="sidebar-link">ROS Day2</a></li><li><a href="/my-blog/ROS/0003.html" class="sidebar-link">ROS Day3</a></li><li><a href="/my-blog/ROS/0004.html" class="sidebar-link">ROS Day4</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/my-blog/GoLearning/" class="sidebar-heading clickable"><span>天天想学习</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/my-blog/NoLearning/" class="sidebar-link">天天不想学习</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="web上的mediarecorder更换stream-录制过程中切换摄像头"><a href="#web上的mediarecorder更换stream-录制过程中切换摄像头" class="header-anchor">#</a> Web上的MediaRecorder更换stream(录制过程中切换摄像头)</h1> <p>今天有人问:<strong>MediaRecorder在录制过程中，能否改变在构造函数中引入的流。</strong></p> <p>这个我还真没有试过，之前写的H5直播虽然我一直声称在手机端可以选择前置或后置摄像头，但实际上一旦选择了就没法更改了......其实我确实有考虑过解决这个问题，但当时实在是太累(lan)了，最后答辩就给糊弄过去了，难得今天不想干正事，试试。</p> <h2 id="过程"><a href="#过程" class="header-anchor">#</a> 过程</h2> <p>首先直接MediaRecorder.stream=new_stream的想法可以省省，不用猜就知道这里面的stream肯定是个只读属性</p> <p><img src="/my-blog/assets/img/20200306232331870.918865e3.jpg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p> <p>一般遇到这种问题我都先去网上看看有没有什么高见，看见这么一个：<a href="https://stackoverflow.com/questions/57838283/is-it-possible-to-change-mediarecorders-stream?r=SearchResults" target="_blank" rel="noopener noreferrer">web audio api - Is it possible to change MediaRecorder's stream? - Stack Overflow<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/my-blog/assets/img/20200306225645769.c7b92515.jpg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p> <p>老哥上来就说做不到，emmmmmmmm....但是提问的人问的是track，我觉得可能跟我想的是不一样的，动手试试吧。既然没法修改stream，我直接new一个新的MediaRecorder替换原来的不可以吗？</p> <p>记得之前看示例的时候有一个是教如何切换使用的设备的（<a href="https://webrtc.github.io/samples/src/content/devices/input-output/" target="_blank" rel="noopener noreferrer">Choose camera, microphone and speaker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），里面演示了如何切换设备以及切换后的效果，怎么实现的并不重要，没那么多时间去细细品味，扒下来代码，找到自己以前写的MediaRecorder的代码，拿出作为代码人的骄傲，开始写一个缝合怪。写到饭点，看完API的顺道去看了一下自己的Chrome版本，放那里没管吃饭去了，回来一看Chrome界面不对，自己给我更新了……更新完之后发现最早写的MediaRecorder代码不管用了我日，好在还有另一份使用blob的还可以，得重新写自己的缝合怪了</p> <p>写完之后大概是这样的：</p> <p><img src="/my-blog/assets/img/20200306235058415.6ee75e53.jpg" alt="img"> 上面的video标签显示的是当前调用的摄像头的实时图像，下面的video标签播放的是使用MediaRecorder录制的，
点击Record按钮MediaRecorder就会开始工作，stop为结束录制，printstate是测试用的，在控制台打印状态信息<img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p> <p>在魔改原来sample代码的过程中，我在设备下拉菜单的事件触发函数里加上了代码，在设备改变之后，new一个新的MediaRecorder替代原来的，将新的设备的stream作为MediaRecorder的参数传入，将其绑定起来。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">gotStream</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//这个函数跟在getUserMedia之后，参数中的stream就是新设备的stream</span>
    
        window<span class="token punctuation">.</span>stream <span class="token operator">=</span> stream<span class="token punctuation">;</span> <span class="token comment">// make stream available to console</span>
        videoElement<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span><span class="token comment">//在上面的video标签中显示</span>
  
        <span class="token comment">//缝合怪</span>
        <span class="token comment">//初始化MediaRecorder</span>
		<span class="token keyword">var</span> record_options <span class="token operator">=</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">audioBitsPerSecond</span><span class="token operator">:</span><span class="token number">128000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">videoBitsPerSecond</span><span class="token operator">:</span><span class="token number">2500000</span><span class="token punctuation">,</span>
			<span class="token literal-property property">mimeType</span> <span class="token operator">:</span> mimeType_for_test
		<span class="token punctuation">}</span>

		<span class="token comment">//创建MediaRecorder</span>
        <span class="token comment">//注意MediaRecorder已经在js文件的开头声明</span>
		mediaRecorder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">MediaRecorder</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span>record_options<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//当录制的数据可用时</span>
		mediaRecorder<span class="token punctuation">.</span><span class="token function-variable function">ondataavailable</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//console.log(e.data);</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>size<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		
				<span class="token keyword">var</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">var</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">'type'</span><span class="token operator">:</span>mimeType_for_test<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				reader<span class="token punctuation">.</span><span class="token function-variable function">onloadend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					sourcebuffer<span class="token punctuation">.</span><span class="token function">appendBuffer</span><span class="token punctuation">(</span>reader<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
					sourcebuffer<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'updateend'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	
	<span class="token comment">//mediaRecorder.start(timecell);</span>
	mediaRecorder<span class="token punctuation">.</span><span class="token function-variable function">onstart</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Record onstart'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mediaRecorder<span class="token punctuation">.</span><span class="token function-variable function">onstop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Record onstop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//缝合怪的尾巴</span>

  <span class="token keyword">return</span> navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">.</span><span class="token function">enumerateDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用于后面的函数更新设备标签</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实际运行起来就遇到了很操蛋的问题</p> <h2 id="mediarecorder无法start"><a href="#mediarecorder无法start" class="header-anchor">#</a> MediaRecorder无法start</h2> <p>在录制过程中直接用new MediaRecorder替换原来的会导致下面的播放卡住，即便sourcebuffer一直在不停地append但是无法播放，于是我考虑是不是在改变stream之前将录制停止，new完之后再重新开始录制。当我这么做了之后遇到了下面的问题：</p> <p><img src="/my-blog/assets/img/20200307000321722.f872c5e4.jpg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p> <p>于是我分阶段在控制台中打印MediaRecorder，检查它的状态</p> <p><img src="/my-blog/assets/img/20200307000410459.d6e4fdd3.jpg" alt="img"> 正常录制过程中</p> <p><img src="/my-blog/assets/img/20200307000449848.986b747e.jpg" alt="img"> 刚刚用new MediaRecorder切换完stream后</p> <p><img src="/my-blog/assets/img/20200307000529982.df3cdb50.jpg" alt="img"> 切换完过了一段时间之后</p> <p>对比上面三个可以发现，在刚刚切换完stream之后，MediaRecorder下的stream属性下的active属性值是false，当一段时间过后才会变为true，当其为false时试图调用MediaRecorder.start()就会导致报错。我看到了active下面还有个onactive，诶嘿嘿这个好东西啊，这不就是active变为true时的触发事件吗，赶紧绑定函数，变为true时就启动我的MediaRecorder！</p> <p>过了好久好久</p> <p>“onactive还没有被实现.......”，我靠了这帮人为什么这么喜欢挖坑不填啊。被逼无奈，在切换stream后等待，当stream.active的值为true时再start我的MediaRecorder。（这里又被自己蠢到了，代码苦手最近C++写太多了，我直接写了个while(1)里面写了个判断跳出循环，然后直接把页面给卡死了....蠢到自己不自知以为是页面开太多了头铁地又试了一次...）写个setTimeout完事</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">tryRestartRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>mediaRecorder<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>active<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
			mediaRecorder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>timecell<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token function">setTimeout</span><span class="token punctuation">(</span>tryRestartRecorder<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">changestream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">try</span><span class="token punctuation">{</span>
		mediaRecorder<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//防止MediaRecorder还没有初始化</span>
	<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//切换stream的函数</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token function">tryRestartRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就成了，切换音频输入输出同理。</p> <h3 id="navigator-mediadevices-enumeratedevices-不显示设备名称"><a href="#navigator-mediadevices-enumeratedevices-不显示设备名称" class="header-anchor">#</a> navigator.mediaDevices.enumerateDevices()不显示设备名称</h3> <p>收尾的时候发现不显示设备名称</p> <p><img src="/my-blog/assets/img/20200306234821687.0ebe9d99.jpg" alt="img"></p> <p><a href="https://blog.csdn.net/ihtml5/article/details/88693446" target="_blank" rel="noopener noreferrer">这个博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>里面提到需要部署到服务器上去才能够获取到设备名称，可能是因为不是https连接导致navigator.mediaDevices.enumerateDevices()函数没有权限</p> <p><img src="/my-blog/assets/img/20200306234736416.287711b8.jpg" alt="img"></p> <h2 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h2> <p><a href="https://winka9587.github.io/MediaRecorder_changestream_sample/" target="_blank" rel="noopener noreferrer">demo地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/my-blog/Web/0003.html" class="prev">
        配置turn服务器实现nat穿透
      </a></span> <span class="next"><a href="/my-blog/Web/0005.html">
        通过mediarecorder+mediasource实现h5直播,以及关于webrtc直播的问题
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/my-blog/assets/js/app.8719d32f.js" defer></script><script src="/my-blog/assets/js/2.fe61bd6b.js" defer></script><script src="/my-blog/assets/js/10.96b7d755.js" defer></script>
  </body>
</html>
