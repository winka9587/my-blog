(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{531:function(e,t,a){e.exports=a.p+"assets/img/20190707213956628.c897d858.jpg"},532:function(e,t,a){e.exports=a.p+"assets/img/20190707213809555.b79305a4.jpg"},533:function(e,t,a){e.exports=a.p+"assets/img/20190707201438405.306a6817.jpg"},534:function(e,t,a){e.exports=a.p+"assets/img/20190707202841287.bc9016cf.jpg"},535:function(e,t,a){e.exports=a.p+"assets/img/20190707203100186.8c84c10d.jpg"},589:function(e,t,a){"use strict";a.r(t);var s=a(56),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"配置turn服务器实现nat穿透"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置turn服务器实现nat穿透"}},[e._v("#")]),e._v(" 配置TURN服务器实现NAT穿透")]),e._v(" "),s("p",[e._v("最近使用WebRTC传输媒体流时，接收端已经成功收到了发送端发来的offer，并且传回的answer也已经发送方被接收，之后接收端的ontrack/onaddstream成功触发，收到了媒体流并且能够打印出来，但是既不能得到画面，也不能得到声音。")]),e._v(" "),s("p",[s("strong",[e._v("先说结论：")])]),e._v(" "),s("p",[e._v("原因在于"),s("strong",[e._v("ice候选")]),e._v("，在本机测试时和局域网测试时我只使用了谷歌的免费STUN服务器，是否成功视网络情况而不同。")]),e._v(" "),s("p",[s("strong",[e._v("本地测试和局域网测试即便没有ice候选也能成功连接传输媒体流，但是一旦部署到服务器上，ice就非常重要了")])]),e._v(" "),s("p",[e._v("-----更新------")]),e._v(" "),s("p",[e._v("有很多朋友看了之后跟我说有相同的问题，接收端也得到了，也成功打印出来了，但是黑屏没有画面。配置了turn服务器之后也没能解决，不知道是turn服务器的问题还是其他的问题。说一下我的想法：也有可能是MIMEType的问题，"),s("strong",[e._v("建议两端用同一个浏览器同一个MIMEType来测试")]),e._v("，因为MIMEType还蛮刁钻的，我当时发送方是Chrome，接收方是FireFox，尽管双方设置的MIMEType相同但接收方黑屏。以后有机会再研究一下MIMEType吧")]),e._v(" "),s("h2",{attrs:{id:"对问题的分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对问题的分析"}},[e._v("#")]),e._v(" 对问题的分析")]),e._v(" "),s("p",[e._v('我找不到思路的地方，在于我"能收到媒体流"（ontrack/onaddstream会触发），但是无法播放，')]),e._v(" "),s("p",[e._v("发送端的ice状态：new -> checking -> close，无法达到connected或者completed，也就无法传输媒体流（onaddstream/ontrack是在RTCPeerConnection的对方挂载媒体流时触发的，并不一定开始传输流）")]),e._v(" "),s("p",[e._v("接收端的RTCPeerConnection")]),e._v(" "),s("p",[e._v("IceConnectionState："),s("strong",[e._v("new")])]),e._v(" "),s("p",[e._v("IceGatheringState：completed")]),e._v(" "),s("p",[e._v("到")]),e._v(" "),s("p",[e._v("IceConnectionState："),s("strong",[e._v("checking")])]),e._v(" "),s("p",[e._v("IceGatheringState：completed")]),e._v(" "),s("p",[e._v("==========================")]),e._v(" "),s("p",[e._v("发送端的RTCPeerConnection则是")]),e._v(" "),s("p",[e._v("IceConnectionState："),s("strong",[e._v("new")])]),e._v(" "),s("p",[e._v("IceGatheringState：completed")]),e._v(" "),s("p",[e._v("到")]),e._v(" "),s("p",[e._v("IceConnectionState："),s("strong",[e._v("checking")])]),e._v(" "),s("p",[e._v("IceGatheringState：completed")]),e._v(" "),s("p",[e._v("到")]),e._v(" "),s("p",[e._v("IceConnectionState："),s("strong",[e._v("closed")])]),e._v(" "),s("p",[e._v("IceGatheringState：completed")]),e._v(" "),s("p",[e._v("也就是说双方都能完成ice候选的收集工作，但是无法连接。")]),e._v(" "),s("p",[e._v("从stackoverflow上摘了一段：")]),e._v(" "),s("p",[e._v("The ice gathering state is not so important, as the application logic does not care usually about those (the application might monitor the candidates and know if the gathering is done when a null candidate surfaces), the ice connection states are "),s("strong",[e._v("VERY important")]),e._v(" to know if a connection was established and your application should focus on that. The peer connection state can be stable, and all the handshake done, without media flowing if the ICE connection state is failed.")]),e._v(" "),s("p",[e._v("也就是说iceConnectionState说明连接是否建立，即便websocket的握手完成，倘若iceConnectionState连接失败（状态不是connected），那么就不会有媒体流传输")]),e._v(" "),s("p",[e._v("考虑到自己在创建RTCPeerConnection时只使用了STUN服务器，是不是需要TURN服务器？")]),e._v(" "),s("h2",{attrs:{id:"我在刚接触turn时的一些疑问"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#我在刚接触turn时的一些疑问"}},[e._v("#")]),e._v(" 我在刚接触TURN时的一些疑问")]),e._v(" "),s("p",[e._v("Q：TURN和STUN的区别")]),e._v(" "),s("p",[e._v("A：百度：“TURN和STUN的区别”，我只是使用了STUN和TURN，并没有对其背后的原理进一步深入了解，就在这里不丢人了。")]),e._v(" "),s("p",[e._v("Q：需要两台服务器吗？TURN服务器可不可以和信令服务器是同一台服务器？")]),e._v(" "),s("p",[e._v("A：一台就够，TURN服务可以和信令转发服务配置在同一台服务器上，只要确保其使用的端口不冲突就可以了，我已经试过并成功了")]),e._v(" "),s("p",[e._v("Q：自己搭TURN服务器感觉好麻烦啊，可以只使用STUN服务器吗？有免费的TURN服务器吗？")]),e._v(" "),s("p",[e._v("A：网上一搜有很多“国内免费的STUN服务器”，具体是否能用你可以用我下面提到的Trickle ICE来检测；")]),e._v(" "),s("p",[e._v("这个网站提供了免费的STUN/TURN服务器（需要注册）http://numb.viagenie.ca/")]),e._v(" "),s("p",[e._v("**但是但是但是！**尽管我在Trickle ICE中能够成功得到ice候选，如下图。而且在使用时RTCPeerConnection的iceConnectionState属性也显示为connected，但我仍然没能成功传输媒体流。在我的整个WebRTC项目完成后我回过头来测试这个仍然不行...")]),e._v(" "),s("p",[s("img",{attrs:{src:a(531),alt:"img"}}),s("img",{attrs:{src:"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==",alt:"点击并拖拽以移动"}})]),e._v(" "),s("p",[e._v("注册后成功后你的邮箱会收到邮件（注册时验证码可能要多刷新几次）")]),e._v(" "),s("p",[s("img",{attrs:{src:a(532),alt:"img"}}),s("img",{attrs:{src:"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==",alt:"点击并拖拽以移动"}})]),e._v(" "),s("p",[s("strong",[e._v("最终我还是搭建了自己的TURN服务器")])]),e._v(" "),s("h2",{attrs:{id:"搭建turn服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建turn服务器"}},[e._v("#")]),e._v(" 搭建TURN服务器")]),e._v(" "),s("p",[e._v("参考：")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://yq.aliyun.com/articles/138462",target:"_blank",rel:"noopener noreferrer"}},[e._v("Centos6 安装 stun/turn服务"),s("OutboundLink")],1),e._v(" https://yq.aliyun.com/articles/138462")]),e._v(" "),s("p",[s("a",{attrs:{href:"https://blog.csdn.net/qq_41345773/article/details/88965707",target:"_blank",rel:"noopener noreferrer"}},[e._v("搭建ICE(TURN、STUN)服务"),s("OutboundLink")],1),e._v(" https://blog.csdn.net/qq_41345773/article/details/88965707")]),e._v(" "),s("p",[e._v("我服务器是CentOS 7.3.x")]),e._v(" "),s("p",[s("strong",[e._v("1.安装必须的文件")])]),e._v(" "),s("p",[e._v("yum install -y make gcc cc gcc-c++ wget")]),e._v(" "),s("p",[e._v("yum install -y openssl-devel libevent libevent-devel mysql-devel mysql-server")]),e._v(" "),s("p",[s("strong",[e._v("2.下载并安装 LibEvent modules")])]),e._v(" "),s("p",[e._v("下载")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("wget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz\n")])])]),s("p",[e._v("解压")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("tar zxvf libevent-2.0.21-stable.tar.gz\n")])])]),s("p",[e._v("进入解压生成的文件夹：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cd libevent-2.0.21-stable \n")])])]),s("p",[e._v("生成makefile文件")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("./configure\n")])])]),s("p",[e._v("执行make")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("sudo make  \n")])])]),s("p",[e._v("安装")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("sudo make install\n")])])]),s("p",[e._v("退回上一级目录")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cd ..\n")])])]),s("p",[s("strong",[e._v("3.下载并安装 TURN modules")])]),e._v(" "),s("p",[e._v("和上面一样")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("wget http://turnserver.open-sys.org/downloads/v4.4.5.2/turnserver-4.4.5.2.tar.gz\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("tar -zxvf turnserver-4.4.5.2.tar.gz\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cd turnserver-4.4.5.2 \n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("./configure\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("sudo make\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("sudo make install\n")])])]),s("p",[s("strong",[e._v("4.turnserver安装成功后会出现如下信息")])]),e._v(" "),s("p",[e._v("告知相关使用事项，需要一直看完（我还以为卡掉了....）")]),e._v(" "),s("ol",[s("li",[e._v("If you system supports automatic start-up system daemon services,")])]),e._v(" "),s("p",[e._v("the, to enable the turnserver as an automatically started system")]),e._v(" "),s("p",[e._v("service, you have to:")]),e._v(" "),s("p",[e._v("​    a) Create and edit /etc/turnserver.conf or")]),e._v(" "),s("p",[e._v("​    /usr/local/etc/turnserver.conf .")]),e._v(" "),s("p",[e._v("​    Use /usr/local/etc/turnserver.conf.default as an example.")]),e._v(" "),s("p",[e._v("​    b) For user accounts settings: set up SQLite or PostgreSQL or")]),e._v(" "),s("p",[e._v("​    MySQL or MongoDB or Redis database for user accounts.")]),e._v(" "),s("p",[e._v("​    Use /usr/local/share/turnserver/schema.sql as SQL database schema,")]),e._v(" "),s("p",[e._v("​    or use /usr/local/share/turnserver/schema.userdb.redis as Redis")]),e._v(" "),s("p",[e._v("​    database schema description and/or")]),e._v(" "),s("p",[e._v("​    /usr/local/share/turnserver/schema.stats.redis")]),e._v(" "),s("p",[e._v("​    as Redis status & statistics database schema description.")]),e._v(" "),s("p",[e._v("​    If you are using SQLite, the default database location is in")]),e._v(" "),s("p",[e._v("​    /var/db/turndb or in /usr/local/var/db/turndb or in /var/lib/turn/turndb.")]),e._v(" "),s("p",[e._v("​    c) add whatever is necessary to enable start-up daemon for the")]),e._v(" "),s("p",[e._v("​    /usr/local/bin/turnserver.")]),e._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[e._v("If you do not want the turnserver to be a system service,")])]),e._v(" "),s("p",[e._v('then you can start/stop it "manually", using the "turnserver"')]),e._v(" "),s("p",[e._v("executable with appropriate options (see the documentation).")]),e._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[e._v("To create database schema, use schema in file")])]),e._v(" "),s("p",[e._v("/usr/local/share/turnserver/schema.sql.")]),e._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[e._v("For additional information, run:")])]),e._v(" "),s("p",[e._v("$ man turnserver")]),e._v(" "),s("p",[e._v("$ man turnadmin")]),e._v(" "),s("p",[e._v("$ man turnutils")]),e._v(" "),s("p",[s("strong",[e._v("5.配置conf文件")])]),e._v(" "),s("p",[e._v("找到以下目录的文件，"),s("strong",[e._v("注意！这个default文件只是个示例！！")])]),e._v(" "),s("p",[e._v("/usr/local/etc/turnserver.conf.default")]),e._v(" "),s("p",[e._v("使用cp命令将其复制到***/etc/turnserver.conf*"),s("strong",[e._v("或")]),e._v("*/usr/local/etc/turnserver.conf***")]),e._v(" "),s("p",[e._v("即执行命令")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cp /usr/local/etc/turnserver.conf.default /etc/turnserver.conf\n")])])]),s("p",[e._v("或")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("cp /usr/local/etc/turnserver.conf.default /usr/local/etc/turnserver.conf\n")])])]),s("p",[e._v("我使用的是第一条命令，第二条命令没有测试")]),e._v(" "),s("p",[s("strong",[e._v("6.修改turnserver.conf的内容")])]),e._v(" "),s("p",[e._v("turnserver.conf文件中有对设置内容的详细描述，学好英语或善用翻译软件")]),e._v(" "),s("p",[e._v("需要设置的主要有以下几点：")]),e._v(" "),s("p",[e._v("内网IP：")]),e._v(" "),s("p",[s("strong",[e._v("listening-ip=172.16.0.13")])]),e._v(" "),s("p",[e._v("端口listening-port不设置默认为3478")]),e._v(" "),s("p",[e._v("外网IP：\n"),s("strong",[e._v("external-ip=106.52.27.49")])]),e._v(" "),s("p",[e._v("长时验证\n"),s("strong",[e._v("lt-cred-mech")])]),e._v(" "),s("p",[e._v("登录用户名&密码（假如我的是winka9587，密码是123）\n"),s("strong",[e._v("user=winka9587:123")])]),e._v(" "),s("p",[e._v("其他的都用默认值")]),e._v(" "),s("p",[s("strong",[e._v("未解决的问题：")])]),e._v(" "),s("p",[e._v("很奇怪的一点，我在conf文件中同时设置两个静态用户就无法成功获得候选")]),e._v(" "),s("p",[e._v("user=user:pwd")]),e._v(" "),s("p",[e._v("user=user2:pwd2")]),e._v(" "),s("p",[e._v("但是如果只设置一个，那么就可以成功获得候选（没搞明白为什么）")]),e._v(" "),s("p",[s("strong",[e._v("7.启动turnserver")])]),e._v(" "),s("p",[e._v("假设你在conf文件中设置的")]),e._v(" "),s("p",[e._v("外网ip为106.52.27.49")]),e._v(" "),s("p",[e._v("端口为"),s("strong",[e._v("3478")])]),e._v(" "),s("p",[s("strong",[e._v("记得去服务器控制台配置好安全组规则，开放3478端口")])]),e._v(" "),s("p",[e._v("你的conf路径为**/etc/turnserver.conf**")]),e._v(" "),s("p",[e._v("执行命令turnserver -v -r "),s("strong",[e._v("106.52.27.49:3478")]),e._v(" -a -o -c "),s("strong",[e._v("/etc/turnserver.conf")])]),e._v(" "),s("p",[s("strong",[e._v("8.关闭turnserver")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("ps -ef|grep turnserver\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("kill -9 [序号]\n")])])]),s("h2",{attrs:{id:"如何测试我的turn服务器是否成功运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何测试我的turn服务器是否成功运行"}},[e._v("#")]),e._v(" 如何测试我的TURN服务器是否成功运行？")]),e._v(" "),s("p",[e._v("浏览器访问 "),s("em",[e._v("http://【 TURN服务器iIP地址 】:【 端口 】")])]),e._v(" "),s("p",[e._v("出现下图 表示TURN服务器已经成功运行")]),e._v(" "),s("p",[s("img",{attrs:{src:a(533),alt:"img"}}),s("img",{attrs:{src:"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==",alt:"点击并拖拽以移动"}})]),e._v(" "),s("p",[e._v("此外，你可能会想看看是否能够成功通过你的TURN服务器获得ICE候选")]),e._v(" "),s("p",[e._v("可以使用"),s("a",{attrs:{href:"https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Trickle ICE"),s("OutboundLink")],1),e._v("，这是WebRTC官方部署在github上的一个示例，可以用它来检测通过STUN/TURN服务器获得的ICE候选")]),e._v(" "),s("p",[e._v("默认的是Google的一个免费STUN服务器"),s("a",{attrs:{href:"http://106.52.27.49:3478/",target:"_blank",rel:"noopener noreferrer"}},[e._v("："),s("OutboundLink")],1),s("em",[e._v("stun.l.google.com:19302")])]),e._v(" "),s("p",[e._v("单击"),s("em",[e._v("Gather candidates")]),e._v("即可通过你输入的所有STUN/TURN服务器收集候选")]),e._v(" "),s("p",[s("img",{attrs:{src:a(534),alt:"img"}})]),e._v(" "),s("p",[e._v("比如我自己的TURN服务器ip及端口为"),s("em",[e._v("106.52.27.49:3478")])]),e._v(" "),s("p",[e._v("因为测试的是TURN服务器，所以前面加上***turn:"),s("strong",[s("em",[e._v("（如果测试STUN服务器就加stun，就像上面的Google服务器是")]),e._v("stun.l.google.com:19302，前面要加上")]),e._v("stun:***）")]),e._v(" "),s("p",[s("em",[e._v("turn:106.52.27.49:3478")])]),e._v(" "),s("p",[s("em",[e._v("用户名xxx")])]),e._v(" "),s("p",[s("em",[e._v("密码xxx")])]),e._v(" "),s("p",[e._v("添加之后收集候选")]),e._v(" "),s("p",[s("img",{attrs:{src:a(535),alt:"img"}}),s("img",{attrs:{src:"data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==",alt:"点击并拖拽以移动"}})]),e._v(" "),s("p",[e._v("Component Type 为 "),s("strong",[e._v("relay")]),e._v(" 的就是通过TURN服务器得到的候选")]),e._v(" "),s("h2",{attrs:{id:"解决ice问题过程中遇到的另一个问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决ice问题过程中遇到的另一个问题"}},[e._v("#")]),e._v(" 解决ICE问题过程中遇到的另一个问题")]),e._v(" "),s("p",[e._v("在尝试解决上面问题的途中我遇到了另一个问题，在使用node-wrtc的过程中我无法SetRemoteDescription，会抛出异常，查看之后发现原因是服务器端的RTCPeerConnection的signalingState在构造函数完成后状态变为closed，而客户端的初始状态为stable（PeerConnection刚刚建立还未开始协商或者已经协商完成，参考："),s("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/signalingState",target:"_blank",rel:"noopener noreferrer"}},[e._v("signalingState的官方文档"),s("OutboundLink")],1),e._v("）")]),e._v(" "),s("p",[e._v("参考问题：https://github.com/feross/simple-peer/issues/426")]),e._v(" "),s("p",[e._v("因为在RTCPeerConnection的构造函数中参数有turn服务器和stun服务器的地址，问题出在其中的url和urls上")]),e._v(" "),s("p",[s("strong",[e._v("WebRTC的最新标准已经抛弃了url，使用urls")])]),e._v(" "),s("p",[s("strong",[e._v("这里说一下我因为绕了一些弯路的原因，在服务器端需要使用WebRTC，所以使用了nodejs的node-wrtc模块，这个模块严格遵守了最新的WebRTC标准，很多官方最新标准中被废弃的功能在这里面“非常及时”地被删除了...而在浏览器上仍然可用，比如onaddstream、url")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('var iceOption= { \n        iceServers: [\n           //stun服务器\n\t\t\t{\n\t\t\t\turls:"stun:stun.l.google.com:19302"\n\t\t\t},\n            //turn服务器&登录用户名&密码\n\t\t\t{\n                urls: "turn:106.52.27.49:3478",\n\t\t\t\tusername:"用户名",\n\t\t\t\tcredential:"密码"\n            }]\n\t\t};\n\nvar pc = new RTCPeerConnection(iceOption);\n')])])]),s("p",[e._v("见iceServer的官方文档")]),e._v(" "),s("p",[e._v("https://developer.mozilla.org/en-US/docs/Web/API/RTCIceServer")]),e._v(" "),s("p",[e._v("解决方案：将url修改为urls")])])}),[],!1,null,null,null);t.default=r.exports}}]);